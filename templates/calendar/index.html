{% extends "_layout/default.html" %}

{% block stylesheet %}
	{{ super() }}
	<link rel="stylesheet" href="{{ url_for('static', filename='fullcalendar/dist/fullcalendar.min.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='fullcalendar/dist/fullcalendar.print.min.css') }}" media="print">
{% endblock %}

{% block body_content %}
	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
    	<!-- Main content -->
	    <section class="content">
			<div class="row">
				<div class="col-md-3">
	        		<div id="external-events-container"></div>
	        	</div>
	        	<!-- /.col -->
	        	<div class="col-md-9">
	          		<div class="box box-primary">
	            		<div class="box-body no-padding">
		              		<!-- THE CALENDAR -->
		              		<div id="calendar"></div>
		            	</div><!-- /.box-body -->	            	
		          	</div><!-- /. box -->
				</div><!-- /.col -->
			</div><!-- /.row -->
		</section><!-- /.content -->
	</div><!-- /.content-wrapper -->
{% endblock %}

{% block bodyscript %}
{{ super() }}
<!-- jQuery UI 1.11.4 -->
<script src="{{ url_for('static', filename='jquery-ui/jquery-ui.min.js') }}"></script>
  
<!-- Slimscroll -->
<script src="{{ url_for('static', filename='jquery-slimscroll/jquery.slimscroll.min.js') }}"></script>

<!-- FastClick -->
<script src="{{ url_for('static', filename='fastclick/lib/fastclick.js') }}"></script>

<!-- fullCalendar -->
<script src="{{ url_for('static', filename='moment/moment.js') }}"></script>
<script src="{{ url_for('static', filename='fullcalendar/dist/fullcalendar.min.js') }}"></script>

<!-- Page specific script -->
<script>
var init_events_container = function(){
	jQuery('#external-events-container').load("{{ url_for('calendar_tag') }}", function(){
		/* initialize the external events
		-----------------------------------------------------------------*/
		function init_events(ele) {
			ele.each(function () {
				// create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
				// it doesn't need to have a start or end
				var eventObject = {
					title: jQuery.trim(jQuery(this).text()) // use the element's text as the event title
				}

		        // store the Event Object in the DOM element so we can get to it later
          		jQuery(this).data('eventObject', eventObject)

          		// make the event draggable using jQuery UI
          		jQuery(this).draggable({
		            zIndex        : 1070,
		            revert        : true, // will cause the event to go back to its
		            revertDuration: 0  //  original position after the drag
				});
       		});
		}
		
		init_events(jQuery('#external-events div.external-event'))

		//Color chooser button
		jQuery('#color-chooser > li > a').click(function(e){
	        e.preventDefault()
	        var currColor = jQuery(this).data('color')
	        var orgcolor  = jQuery('#add-new-event').data('color'); 
	        jQuery('#add-new-event').removeClass('bg-' + orgcolor);
	        jQuery('#add-new-event').addClass('bg-' + currColor);
	        jQuery('#add-new-event').data('color', currColor);
		});
     
		jQuery('#add-new-event').click(function(){
	        var post_data = {
				tag_name    : jQuery('#new-event').val(),
				tag_color   : jQuery(this).data('color')
	        };
	        jQuery.post("{{ url_for('calendar_tag_add') }}", post_data, function(json){
				if(checkAjaxResponse(json)){
					init_events_container();
				}
	        }, 'json');
		});
	});  
}
  
jQuery(function () {
    init_events_container();

    /* initialize the calendar
     -----------------------------------------------------------------*/
	jQuery('#calendar').fullCalendar({
		header    	: {
			left  	: 'prev,next, today',
			center	: 'title',
			right	: 'month,agendaWeek,agendaDay'
		},
		buttonText: { 
			today: '今天',
        	month: '月',
        	week : '周',
        	day  : '日'
		},
		dayNames		: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
		dayNamesShort	: ["日", "一", "二", "三", "四", "五", "六"],
        monthNames		: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
        monthNamesShort	: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
		events			: { url: "{{ url_for('calendar_events') }}" },
		editable		: true,
		droppable		: true, // this allows things to be dropped onto the calendar !!!
		drop			: function (date, allDay) { // this function is called when something is dropped
			
	        // retrieve the dropped element's stored Event Object
	        var originalEventObject = $(this).data('eventObject')
	
	        // we need to copy it, so that multiple events don't have a reference to the same object
	        var copiedEventObject = $.extend({}, originalEventObject)
	
	        // assign it the date that was reported
	        copiedEventObject.start           = date
	        copiedEventObject.allDay          = allDay
	        copiedEventObject.backgroundColor = $(this).css('background-color')
	        copiedEventObject.borderColor     = $(this).css('border-color')
	
	        // render the event on the calendar
	        // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
	        $('#calendar').fullCalendar('renderEvent', copiedEventObject, true)
		}
	});
});
</script>
{% endblock %}